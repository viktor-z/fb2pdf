<?xml version="1.0" encoding="UTF-8"?>

<project name="cluster books">

  <property name="fb2pdf.hamake.bucket" value="fb2pdf-hamake" />
  <property name="book.storage.bucket" value="fb2pdf-hamake-test" />
  <property name="lib" value="s3://${fb2pdf.hamake.bucket}/lib" />
  <property name="data" value="s3://${fb2pdf.hamake.bucket}/data" />
  <property name="cosine.distance" value="0.002" />

  <fileset id="input" path="s3://${book.storage.bucket}" mask="*.fb2" />
  <file id="output" path="s3://${fb2pdf.hamake.bucket}/similar_books/clusters" />
  <file id="stopwords" path="s3://${fb2pdf.hamake.bucket}/stopwords" />

  <file id="vectors" path="${data}/SparseVectorsFromSequenceFilesOutput/vectors" />
  <file id="FB2MetaExtractorOut" path="${data}/FB2MetaExtractorOut/${foreach:filename}" />

  <foreach name="FB2MetaExtractor">
    <input>
      <include idref="input" />
    </input>
    <output>
      <include idref="FB2MetaExtractorOut" />
    </output>
    <mapreduce jar="${lib}/fb2pdf.job" main="com.fb2pdf.hadoop.cluster.FB2MetaExtractor">
      <parameter>
        <literal value="${foreach:path}" />
      </parameter>
      <parameter>
        <reference idref="FB2MetaExtractorOut" />
      </parameter>
    </mapreduce>
  </foreach>

  <foreach name="FB2KeywordsExtractor">
    <input>
      <include idref="input" />
    </input>
    <output>
      <file id="FB2KeywordsExtractorOut" path="${data}/FB2KeywordsExtractorOut/${foreach:filename}" />
    </output>
    <mapreduce jar="${lib}/fb2pdf.job" main="com.fb2pdf.hadoop.cluster.FB2KeywordsExtractor">
      <parameter>
        <literal value="${foreach:path}" />
      </parameter>
      <parameter>
        <reference idref="FB2KeywordsExtractorOut" />
      </parameter>
    </mapreduce>
  </foreach>

  <foreach name="FB2StopwordsExcluder">

    <dependencies>
      <include idref="FB2MetaExtractorOut" />
    </dependencies>

    <input>
      <fileset path="${data}/FB2KeywordsExtractorOut/" />
    </input>
    <output>
      <file id="FB2StopwordsExcluderOut" path="${data}/FB2KeywordsFilteredOut/${foreach:filename}" />
    </output>

    <mapreduce jar="${lib}/fb2pdf.job" main="com.fb2pdf.hadoop.cluster.FB2StopwordsExcluder">
      <parameter>
        <literal value="${foreach:path}" />
      </parameter>
      <parameter>
        <reference idref="FB2StopwordsExcluderOut" />
      </parameter>
      <parameter>
        <reference idref="stopwords" />
      </parameter>
      <parameter>
        <reference idref="FB2MetaExtractorOut"/>
      </parameter>
    </mapreduce>
  </foreach>

  <fold name="SequenceFilesFromDirectory">
    <input>
      <file id="SequenceFilesFromDirectoryIn" path="${data}/FB2KeywordsFilteredOut/" />
    </input>
    <output>
      <file id="SequenceFilesFromDirectoryOut" path="${data}/SequenceFilesFromDirectoryOutput" />
    </output>
    <mapreduce jar="${lib}/fb2pdf.job" main="com.fb2pdf.hadoop.cluster.SequenceFilesFromDirectory">
      <parameter>
        <reference idref="SequenceFilesFromDirectoryIn" />
      </parameter>
      <parameter>
        <reference idref="SequenceFilesFromDirectoryOut" />
      </parameter>
      <parameter>
        <literal value="part-" />
      </parameter>
    </mapreduce>
  </fold>
  <foreach name="SparseVectorsFromSequenceFiles">
    <input>
      <file id="SparseVectorsFromSequenceFilesIn" path="${data}/SequenceFilesFromDirectoryOutput/" />
    </input>
    <output>
      <file id="SparseVectorsFromSequenceFilesOut" path="${data}/SparseVectorsFromSequenceFilesOutput/" />
    </output>
    <mapreduce jar="${lib}/mahout/mahout-utils-0.3.jar" main="org.apache.mahout.text.SparseVectorsFromSequenceFiles">
      <classpath>
        <fileset path="${lib}/mahout" mask="*.jar" />
      </classpath>
      <parameter>
        <literal value="-i" />
      </parameter>
      <parameter>
        <reference idref="SparseVectorsFromSequenceFilesIn" />
      </parameter>
      <parameter>
        <literal value="-o" />
      </parameter>
      <parameter>
        <reference idref="SparseVectorsFromSequenceFilesOut" />
      </parameter>
      <parameter>
        <literal value="-chunk" />
      </parameter>
      <parameter>
        <literal value="64" />
      </parameter>
      <parameter>
        <literal value="-s"/>
      </parameter>
      <parameter>
        <literal value="100" />
      </parameter>
      <parameter>
        <literal value="-wt" />
      </parameter>
      <parameter>
        <literal value="tf" />
      </parameter>
    </mapreduce>
  </foreach>
  <foreach name="MeanShiftCanopy">
    <input>
      <include idref="vectors" />
    </input>
    <output>
      <file id="MeanShiftCanopyOut" path="${data}/MeanShiftCanopyOutput/" />
    </output>
    <mapreduce jar="${lib}/fb2pdf.job" main="com.fb2pdf.hadoop.cluster.MeanShiftCanopyDriver">
      <classpath>
        <fileset path="${lib}/mahout" mask="*.jar" />
      </classpath>
      <parameter>
        <literal value="${cosine.distance}" />
      </parameter>
      <parameter>
        <reference idref="vectors" />
      </parameter>
      <parameter>
        <reference idref="MeanShiftCanopyOut" />
      </parameter>
    </mapreduce>
  </foreach>
  <foreach name="MeanShiftOutDumper">
    <input>
      <file id="MeanShiftOutDumperIn" path="${data}/MeanShiftCanopyOutput/" />
    </input>
    <output>
      <include idref="output" />
    </output>
    <mapreduce jar="${lib}/fb2pdf.job" main="com.fb2pdf.hadoop.cluster.OutputClusterResults">
      <classpath>
        <fileset path="${lib}/mahout" mask="*.jar" />
      </classpath>
      <parameter>
        <literal value="${cosine.distance}" />
      </parameter>
      <parameter>
        <reference idref="MeanShiftOutDumperIn" />
      </parameter>
      <parameter>
        <reference idref="vectors" />
      </parameter>
      <parameter>
        <reference idref="output" />
      </parameter>
    </mapreduce>
  </foreach>

</project>
